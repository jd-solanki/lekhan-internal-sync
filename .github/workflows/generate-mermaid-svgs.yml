name: ðŸ–¼ï¸ Generate Mermaid SVGs

# This workflow automatically generates SVG files from Mermaid diagrams
# Supports:
# - Standalone .mmd and .mermaid files
# - Automatic commit on main branch

on:
  push:
    branches: [main]
    paths:
      - '**/*.mmd'
      - '**/*.mermaid'
  pull_request:
    branches: [main]
    paths:
      - '**/*.mmd'
      - '**/*.mermaid'
  workflow_dispatch:

jobs:
  generate-mermaid-svgs:
    runs-on: ubuntu-latest

    steps:
      # It converts all secrets to environment variables for subsequent steps.
      - name: ðŸ¤« Expose GitHub Secrets as Environment Variables for zod validation & usage
        run: |
          echo "Converting secrets to environment variables..."
          # The toJSON(secrets) function serializes the secrets context into a JSON string.
          # We pipe this to jq to parse it. For each key-value pair, it prints "KEY=VALUE".
          # This output is then appended to the $GITHUB_ENV file.
          # The runner automatically picks up these variables for all following steps.
          echo '${{ toJSON(secrets) }}' | jq -r 'to_entries|map("\(.key)=\(.value)")|.[]' >> $GITHUB_ENV
          echo "Secrets exposed."

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install

      - name: Install Mermaid CLI
        run: npm install -g @mermaid-js/mermaid-cli

      - name: Get changed Mermaid files
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            # For push events, get files changed in the current commit
            changed_files=$(git diff --name-only HEAD~1 HEAD | grep -E '\.(mmd|mermaid)$' || true)
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            # For pull requests, get files changed in the PR
            changed_files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(mmd|mermaid)$' || true)
          else
            # For manual dispatch, find all files
            changed_files=$(find . -name "*.mmd" -o -name "*.mermaid" -type f | grep -v node_modules | grep -v .git || true)
          fi

          if [ -z "$changed_files" ]; then
            echo "No .mmd or .mermaid files found"
            echo "files=" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found Mermaid files:"
          echo "$changed_files"
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$changed_files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate SVGs from changed Mermaid files
        if: steps.changed-files.outputs.files != ''
        run: |
          echo "${{ steps.changed-files.outputs.files }}" | xargs pnpm mermaid:generate

      - name: Commit generated SVGs (on main branch only)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push' && steps.changed-files.outputs.files != ''
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Add any new or modified SVG files
          git add "**/*.svg" || true

          if [ -n "$(git status --porcelain | grep '\.svg$')" ]; then
            git commit -m "feat: auto-generate Mermaid SVG diagrams"
            git push
          else
            echo "No SVG changes to commit"
          fi
